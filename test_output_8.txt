============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\GUTTERS
configfile: pyproject.toml
plugins: anyio-4.12.1, Faker-37.3.0, langsmith-0.6.4, asyncio-1.3.0, mock-3.14.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

tests\integration\features\test_quests_fidelity.py FF.                   [100%]

================================== FAILURES ===================================
________________________ test_quest_manager_lifecycle _________________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x00000192C3C12AE0>
test_user = <src.app.models.user.User object at 0x00000192C3C55B50>

    @pytest.mark.asyncio
    async def test_quest_manager_lifecycle(db: AsyncSession, test_user):
        # Mock Redis pool for ARQ
        with patch("src.app.modules.features.quests.manager.create_pool") as mock_create_pool:
            # The pool is used as "await create_pool()", returning valid redis object
            # but in our code we do: redis = await create_pool; try... finally: await redis.close()
    
            mock_redis = MagicMock()
    
            # Async mock for create_pool result
            async def get_redis(*args, **kwargs):
                return mock_redis
    
            mock_create_pool.side_effect = get_redis
    
            # Async mock for enqueue_job
            async def async_enqueue(*args, **kwargs):
                return "job-123"
    
            mock_redis.enqueue_job.side_effect = async_enqueue
    
            # Async mock for close
            async def async_close():
                pass
    
            mock_redis.close.side_effect = async_close
    
            # 1. Create Quest
>           quest = await QuestManager.create_quest(
                db=db,
                user_id=test_user.id,
                title="Morning Meditation",
                description="Meditate for 10 mins",
                recurrence=RecurrenceType.ONCE,
            )

tests\integration\features\test_quests_fidelity.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
src\app\modules\features\quests\manager.py:51: in create_quest
    from src.app.core.scheduler import redis_settings
src\app\core\scheduler.py:20: in <module>
    host=settings.REDIS_HOST,
         ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Settings(VAPID_PUBLIC_KEY='BLfURgYdgdgyf8pzhi8jmIO6iakT1k_UPXPLeFKTYHN6H6qyP7CDXvAW5hoGegIakkCPK-mQuVg5zJxnqH8PY6E', V...71', POSTGRES_URI='postgres.xrihizuhwdbwbcderbcp:nwp657kvt1998@aws-1-ap-southeast-2.pooler.supabase.com:6543/postgres')
item = 'REDIS_HOST'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra and item in pydantic_extra:
                return pydantic_extra[item]
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'Settings' object has no attribute 'REDIS_HOST'

.venv\Lib\site-packages\pydantic\main.py:1026: AttributeError
________________________ test_quest_tools_integration _________________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x00000192C3C12870>
test_user = <src.app.models.user.User object at 0x00000192C3DCA9F0>

    @pytest.mark.asyncio
    async def test_quest_tools_integration(db: AsyncSession, test_user):
        with patch("src.app.modules.features.quests.manager.create_pool") as mock_create_pool:
            mock_redis = MagicMock()
            mock_create_pool.return_value = mock_redis
    
            async def async_enqueue(*args, **kwargs):
                return "job-123"
    
            mock_redis.enqueue_job.side_effect = async_enqueue
    
            async def async_close():
                pass
    
            mock_redis.close.side_effect = async_close
    
            create_tool = get_create_quest_tool(test_user.id, db)
            list_tool = get_list_quests_tool(test_user.id, db)
    
            # 1. Create via Tool
            result = await create_tool.ainvoke({"title": "Read a Book", "recurrence": "daily"})
>           assert "created successfully" in result
E           assert 'created successfully' in "Failed to create quest: 'Settings' object has no attribute 'REDIS_HOST'"

tests\integration\features\test_quests_fidelity.py:97: AssertionError
============================== warnings summary ===============================
tests/integration/features/test_quests_fidelity.py::test_push_notification_service
  C:\dev\GUTTERS\.venv\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/features/test_quests_fidelity.py::test_quest_manager_lifecycle
FAILED tests/integration/features/test_quests_fidelity.py::test_quest_tools_integration
=================== 2 failed, 1 passed, 1 warning in 1.87s ====================
