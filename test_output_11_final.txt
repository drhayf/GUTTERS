============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\GUTTERS
configfile: pyproject.toml
plugins: anyio-4.12.1, Faker-37.3.0, langsmith-0.6.4, asyncio-1.3.0, mock-3.14.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 2 items

tests\integration\features\test_insight_engine.py .F                     [100%]

================================== FAILURES ===================================
_______________________ test_insight_lunar_anticipation _______________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x000001DFE7042B70>
cleanup_insight_data = None
mock_managers = <test_insight_engine.MockNotificationService object at 0x000001DFE7043830>
ensure_profile = <src.app.models.user.User object at 0x000001DFE7012C60>

    @pytest.mark.asyncio
    async def test_insight_lunar_anticipation(db: AsyncSession, cleanup_insight_data, mock_managers, ensure_profile):
        """Test Predictive Trigger for Lunar Anticipation."""
        user_id = ensure_profile.id
        manager = InsightManager()
        manager.notification_service = mock_managers
    
        storage = ObserverFindingStorage()
        await storage.store_finding(
            user_id, {"pattern_type": "lunar_phase", "phase": "Full", "finding": "User gets anxious during Full Moon"}, db
        )
    
        # Simulate Predictive Trigger (24h before Full Moon)
        cosmic_data = {
            "moon_event_type": "anticipation",
            "moon_phase_name": "Full",  # Approaching Full
            "time_until": 24,
        }
    
        prompts = await manager.evaluate_cosmic_triggers(user_id, cosmic_data, db)
    
>       assert len(prompts) == 1
E       assert 0 == 1
E        +  where 0 = len([])

tests\integration\features\test_insight_engine.py:173: AssertionError
---------------------------- Captured stderr call -----------------------------
[2m2026-01-26T08:18:18.886671Z[0m [[32m[1minfo     [0m] [1mEvaluating triggers for user 79 with data {'moon_event_type': 'anticipation', 'moon_phase_name': 'Full', 'time_until': 24}[0m [[0m[1m[34msrc.app.modules.intelligence.insight.manager[0m][0m
------------------------------ Captured log call ------------------------------
INFO     src.app.modules.intelligence.insight.manager:manager.py:45 Evaluating triggers for user 79 with data {'moon_event_type': 'anticipation', 'moon_phase_name': 'Full', 'time_until': 24}
============================== warnings summary ===============================
src\app\modules\intelligence\insight\schemas.py:27
  C:\dev\GUTTERS\src\app\modules\intelligence\insight\schemas.py:27: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReflectionPromptRead(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/features/test_insight_engine.py::test_insight_lunar_anticipation
=================== 1 failed, 1 passed, 1 warning in 2.99s ====================
