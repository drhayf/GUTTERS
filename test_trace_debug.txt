2026-01-26T06:08:45.547321Z [info     ] Registered calculation module: human_design (v1.0.0) [src.app.modules.calculation.registry]
2026-01-26T06:08:45.549393Z [info     ] Registered module: human_design (layer: calculation) [src.app.modules.registry]
2026-01-26T06:08:47.552376Z [info     ] Registered calculation module: numerology (v1.0.0) [src.app.modules.calculation.registry]
2026-01-26T06:08:47.554392Z [info     ] Registered module: numerology (layer: calculation) [src.app.modules.registry]
2026-01-26T06:08:47.664577Z [info     ] Registered calculation module: astrology (v1.0.0) [src.app.modules.calculation.registry]
2026-01-26T06:08:47.684059Z [info     ] Registered module: astrology (layer: calculation) [src.app.modules.registry]
2026-01-26T06:08:47.692829Z [info     ] Registered module: query (layer: intelligence) [src.app.modules.registry]
2026-01-26T06:08:47.698375Z [info     ] Registered module: synthesis (layer: intelligence) [src.app.modules.registry]
2026-01-26T06:08:49.307133Z [info     ] Registered module: observer (layer: intelligence) [src.app.modules.registry]
============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\GUTTERS
configfile: pyproject.toml
plugins: anyio-4.12.1, Faker-37.3.0, langsmith-0.6.4, asyncio-1.3.0, mock-3.14.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

2026-01-26T06:08:53.154551Z [info     ] HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK" [httpx]
2026-01-26T06:08:56.861835Z [error    ] Answer generation failed: 'coroutine' object has no attribute 'ainvoke' [src.app.modules.intelligence.query.engine]
tests\integration\intelligence\test_tools_fidelity.py ..F

================================== FAILURES ===================================
_______________________ test_engine_tool_execution_flow _______________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x00000198D624A660>
test_user = <src.app.models.user.User object at 0x00000198D67AF350>

    @pytest.mark.asyncio
    async def test_engine_tool_execution_flow(db: AsyncSession, test_user):
        """
        Test the full QueryEngine loop with a mocked LLM forcing a tool call.
        We mock the LLM decision but execute the REAL tool and REAL calculator.
        """
        # 1. Setup Engine with Mock LLM
        mock_llm = AsyncMock()
        mock_llm.model_name = "mock-gpt-4"  # Fix serialization error in logger
        mock_llm.bind_tools.return_value = mock_llm  # mimic binding returning a runnable
    
        # Define the sequence of LLM responses:
        # 1. First call -> Returns Tool Call (Calculate Astrology)
        # 2. Second call -> Returns Final Answer (Interpretation)
    
        tool_call_msg = AIMessage(
            content="",
            tool_calls=[
                {
                    "name": "calculate_astrology_chart",
                    "args": {
                        "name": "Test User",
                        "birth_date": "1990-05-15",
                        "birth_time": "14:30",
                        "latitude": 40.7128,
                        "longitude": -74.0060,
                        "timezone": "America/New_York",
                    },
                    "id": "call_12345",
                }
            ],
        )
    
        final_answer_msg = AIMessage(content="Your sun is in Taurus.")
    
        # Configure mock side_effect
        mock_llm.ainvoke.side_effect = [tool_call_msg, final_answer_msg]
    
        engine = QueryEngine(llm=mock_llm)
    
        # 2. Execute Query
        response = await engine.answer_query(user_id=test_user.id, question="Calculate my chart", db=db)
    
        # 3. Verify Interactions
    
        # Check that bind_tools was called
        assert mock_llm.bind_tools.called
    
        # Verify Trace recorded the tool call
        trace = response.trace
        tool_steps = [s for s in trace.tools_used if s.tool == "calculator"]
    
>       assert len(tool_steps) > 0
E       assert 0 > 0
E        +  where 0 = len([])

tests\integration\intelligence\test_tools_fidelity.py:115: AssertionError
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
ERROR    src.app.modules.intelligence.query.engine:engine.py:866 Answer generation failed: 'coroutine' object has no attribute 'ainvoke'
============================== warnings summary ===============================
tests/integration/intelligence/test_tools_fidelity.py::test_astrology_tool_execution
  C:\dev\GUTTERS\.venv\Lib\site-packages\kerykeion\backword.py:155: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    NOW = _dt.utcnow()

tests/integration/intelligence/test_tools_fidelity.py::test_engine_tool_execution_flow
  C:\dev\GUTTERS\src\app\modules\intelligence\query\engine.py:255: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    answer, confidence = await self._generate_answer(
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/intelligence/test_tools_fidelity.py::test_engine_tool_execution_flow
=================== 1 failed, 2 passed, 2 warnings in 6.91s ===================
