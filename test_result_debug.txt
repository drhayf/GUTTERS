============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\GUTTERS
configfile: pyproject.toml
plugins: anyio-4.12.1, Faker-37.3.0, langsmith-0.6.4, asyncio-1.3.0, mock-3.14.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

tests\integration\intelligence\test_tools_fidelity.py ..F                [100%]

================================== FAILURES ===================================
_______________________ test_engine_tool_execution_flow _______________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x000002295C950A70>
test_user = <src.app.models.user.User object at 0x000002295CE63E30>

    @pytest.mark.asyncio
    async def test_engine_tool_execution_flow(db: AsyncSession, test_user):
        """
        Test the full QueryEngine loop with a mocked LLM forcing a tool call.
        We mock the LLM decision but execute the REAL tool and REAL calculator.
        """
        # 1. Setup Engine with Mock LLM
        mock_llm = AsyncMock()
        mock_llm.bind_tools.return_value = mock_llm  # mimic binding returning a runnable
    
        # Define the sequence of LLM responses:
        # 1. First call -> Returns Tool Call (Calculate Astrology)
        # 2. Second call -> Returns Final Answer (Interpretation)
    
        tool_call_msg = AIMessage(
            content="",
            tool_calls=[
                {
                    "name": "calculate_astrology_chart",
                    "args": {
                        "name": "Test User",
                        "birth_date": "1990-05-15",
                        "birth_time": "14:30",
                        "latitude": 40.7128,
                        "longitude": -74.0060,
                        "timezone": "America/New_York",
                    },
                    "id": "call_12345",
                }
            ],
        )
    
        final_answer_msg = AIMessage(content="Your sun is in Taurus.")
    
        # Configure mock side_effect
        mock_llm.ainvoke.side_effect = [tool_call_msg, final_answer_msg]
    
        engine = QueryEngine(llm=mock_llm)
    
        # 2. Execute Query
        response = await engine.answer_query(user_id=test_user.id, question="Calculate my chart", db=db)
    
        # 3. Verify Interactions
    
        # Check that bind_tools was called
>       assert mock_llm.bind_tools.called
E       AssertionError: assert False
E        +  where False = <AsyncMock name='mock.bind_tools' id='2376675505024'>.called
E        +    where <AsyncMock name='mock.bind_tools' id='2376675505024'> = <AsyncMock id='2376675072320'>.bind_tools

tests\integration\intelligence\test_tools_fidelity.py:108: AssertionError
---------------------------- Captured stderr call -----------------------------
[2m2026-01-26T06:05:52.013616Z[0m [[32m[1minfo     [0m] [1mHTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"[0m [[0m[1m[34mhttpx[0m][0m
[2m2026-01-26T06:05:55.364688Z[0m [[31m[1merror    [0m] [1mAnswer generation failed: Object of type AsyncMock is not JSON serializable[0m [[0m[1m[34msrc.app.modules.intelligence.query.engine[0m][0m
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1740 HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
ERROR    src.app.modules.intelligence.query.engine:engine.py:866 Answer generation failed: Object of type AsyncMock is not JSON serializable
============================== warnings summary ===============================
tests/integration/intelligence/test_tools_fidelity.py::test_astrology_tool_execution
  C:\dev\GUTTERS\.venv\Lib\site-packages\kerykeion\backword.py:155: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    NOW = _dt.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/intelligence/test_tools_fidelity.py::test_engine_tool_execution_flow
=================== 1 failed, 2 passed, 1 warning in 6.80s ====================
