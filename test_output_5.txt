============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\dev\GUTTERS
configfile: pyproject.toml
plugins: anyio-4.12.1, Faker-37.3.0, langsmith-0.6.4, asyncio-1.3.0, mock-3.14.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 3 items

tests\integration\features\test_quests_fidelity.py FFF                   [100%]

================================== FAILURES ===================================
________________________ test_quest_manager_lifecycle _________________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x000001A5A3F82900>
test_user = <src.app.models.user.User object at 0x000001A5A3FC4DA0>

    @pytest.mark.asyncio
    async def test_quest_manager_lifecycle(db: AsyncSession, test_user):
        # Mock Redis pool for ARQ
>       with patch("src.app.modules.features.quests.manager.create_pool") as mock_create_pool:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\features\test_quests_fidelity.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Python312\Lib\unittest\mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x000001A5A3F828D0>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.app.modules.features.quests.manager' from 'C:\\dev\\GUTTERS\\src\\app\\modules\\features\\quests\\manager.py'> does not have the attribute 'create_pool'

C:\Python312\Lib\unittest\mock.py:1437: AttributeError
________________________ test_quest_tools_integration _________________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x000001A5A3F55010>
test_user = <src.app.models.user.User object at 0x000001A5A3FC5E50>

    @pytest.mark.asyncio
    async def test_quest_tools_integration(db: AsyncSession, test_user):
>       with patch("src.app.modules.features.quests.manager.create_pool") as mock_create_pool:
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\integration\features\test_quests_fidelity.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Python312\Lib\unittest\mock.py:1467: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <unittest.mock._patch object at 0x000001A5A3F55850>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'src.app.modules.features.quests.manager' from 'C:\\dev\\GUTTERS\\src\\app\\modules\\features\\quests\\manager.py'> does not have the attribute 'create_pool'

C:\Python312\Lib\unittest\mock.py:1437: AttributeError
_______________________ test_push_notification_service ________________________

db = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x000001A5A3FC6510>
test_user = <src.app.models.user.User object at 0x000001A5A3FC6C00>

    @pytest.mark.asyncio
    async def test_push_notification_service(db: AsyncSession, test_user):
        # Setup Subscription
        sub = PushSubscription(
            user_id=test_user.id, endpoint="https://fcm.googleapis.com/fcm/send/test", p256dh="test_key", auth="test_auth"
        )
        db.add(sub)
        await db.commit()
    
        # Mock pywebpush
        with patch("src.app.modules.infrastructure.push.service.webpush") as mock_webpush:
            res = await notification_service.send_to_user(db=db, user_id=test_user.id, title="Test", body="Body")
>           assert res["success"] == 1
E           assert 3 == 1

tests\integration\features\test_quests_fidelity.py:109: AssertionError
============================== warnings summary ===============================
tests/integration/features/test_quests_fidelity.py::test_push_notification_service
  C:\dev\GUTTERS\.venv\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/integration/features/test_quests_fidelity.py::test_quest_manager_lifecycle
FAILED tests/integration/features/test_quests_fidelity.py::test_quest_tools_integration
FAILED tests/integration/features/test_quests_fidelity.py::test_push_notification_service
======================== 3 failed, 1 warning in 1.35s =========================
